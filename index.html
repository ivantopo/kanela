<html><head><title>kamon-agent</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="kamon-io" /><meta name="description" content="Open Source Java Agent for the JVM" /><meta name="og:image" content="/kamon-agent/img/poster.png" /><meta name="og:title" content="kamon-agent" /><meta name="og:site_name" content="kamon-agent" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Open Source Java Agent for the JVM" /><link rel="icon" type="image/png" href="/kamon-agent/img/favicon.png" /><meta name="twitter:title" content="kamon-agent" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="Open Source Java Agent for the JVM" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/kamon-agent/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/kamon-agent/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/kamon-agent/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/kamon-agent/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/kamon-agent/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/kamon-agent/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/kamon-agent/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/kamon-agent/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/kamon-agent/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/kamon-agent/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/kamon-agent/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/kamon-agent/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/kamon-agent/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/kamon-agent/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/kamon-agent/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/kamon-agent/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/kamon-agent/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/kamon-agent/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/kamon-agent/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/kamon-agent/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/kamon-agent/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/kamon-agent/css/style.css" /><link rel="stylesheet" href="/kamon-agent/css/palette.css" /><link rel="stylesheet" href="/kamon-agent/css/codemirror.css" /></head><body><header id="site-header"><div class="navbar-wrapper"><div class="container"><div class="row"><div class="col-xs-6"><a href="/kamon-agent/" class="brand"><div class="icon-wrapper"><span>kamon-agent</span></div></a></div><div class="col-xs-6"><nav class="text-right"><ul class=""><li><a href="https://github.com/kamon-io/kamon-agent"><i class="fa fa-github"></i><span class="hidden-xs">GitHub</span></a></li></ul></nav></div></div></div></div><div class="jumbotron"><div class="container"><h1 class="text-center">Open Source Java Agent for the JVM</h1><h2></h2><p class="text-center"><a href="https://github.com/kamon-io/kamon-agent" class="btn btn-outline-inverse">View on GitHub</a></p></div></div><div><ul class="horizontalNav">       <li><a class="" href="/kamon-agent/scala-api.html">Scala-Api</a></li>  <li><a class="" href="/kamon-agent/changelog.html">Changelog</a></li>  <li><a class="" href="/kamon-agent/license.html">License</a></li> </ul></div></header><main id="site-main"><section class="use"><div class="container"><div id="content"><h1 id="kamon-agent-">Kamon Agent <img align="right" src="https://rawgit.com/kamon-io/Kamon/master/kamon-logo.svg" height="150px" style="padding-left: 20px" /></h1>
<p><a href="https://travis-ci.org/kamon-io/kamon-agent"><img src="https://travis-ci.org/kamon-io/kamon-agent.svg?branch=master" alt="Build Status" /></a></p>

<p>The <strong>kamon-agent</strong> is developed in order to provide a simple way to instrument an application running on the JVM and
introduce kamon features such as, creation of traces, metric measures, trace propagation, and so on.</p>

<p>It’s a simple Java Agent written in Java 8 and powered by <a href="http://bytebuddy.net/#/">ByteBuddy</a> with some additionally <a href="http://asm.ow2.org/">ASM</a> features. It has a Pure-Java API and a
Scala-Friendly API to define the custom instrumentation in a declarative manner.</p>

<p>Kamon has several module that need to instrument the app to introduce itself in the internal components. Introducing this Agent,
you have other way to instrument your <code class="highlighter-rouge">app / library / framework</code> through a simple and declarative API and get additional features such as
retransformation of the loaded classes (so it’s possible to attach agent on the runtime), revoke the instrumentation
when the app is in a critical state, and so on.</p>

<h3 id="how-to-use-the-agent-api">How to use the Agent API?</h3>

<p>The API has a version for <em>Java</em> and other one for <em>Scala</em>. To define the transformations you have to extends the
<code class="highlighter-rouge">KamonInstrumentation</code> type (picking the Java or the Scala version) and define a new module in the configuration, as you can see
in the following example.</p>

<h2 id="example">Example</h2>

<p>Suppose you have a simple worker that perform a simple operation:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Random</span><span class="o">();</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">performTask</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">long</span><span class="o">)(</span><span class="n">random</span><span class="o">.</span><span class="na">nextFloat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">500</span><span class="o">));</span>
  <span class="o">}</span>   
<span class="o">}</span>
</code></pre>
</div>

<p>You might want to mixin it with a type that provide a way to accumulate metrics, such as the following:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonitorAware</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="nf">execTimings</span><span class="o">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">addExecTimings</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">);</span>
<span class="o">}</span>

</code></pre>
</div>

<p>And introduce some transformations in order to modify the bytecode and hook into the internal app.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">kamon.agent.api.instrumentation.KamonInstrumentation</span><span class="o">;</span>

<span class="c1">// And other imports !</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MonitorInstrumentation</span> <span class="kd">extends</span> <span class="n">KamonInstrumentation</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">MonitorInstrumentation</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">forTargetType</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"app.kamon.java.Worker"</span><span class="o">,</span> <span class="n">builder</span> <span class="o">-&gt;</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">withMixin</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">MonitorMixin</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">withAdvisorFor</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"performTask"</span><span class="o">),</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">WorkerAdvisor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MonitorMixin</span> <span class="kd">implements</span> <span class="n">MonitorAware</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">_execTimings</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">execTimings</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">_execTimings</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="nf">execTimings</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">_execTimings</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">addExecTimings</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">_execTimings</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">oldValues</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">oldValues</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">vs</span> <span class="o">-&gt;</span> <span class="n">vs</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">time</span><span class="o">)).</span><span class="na">getOrElse</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">time</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="nd">@Initializer</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">_execTimings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">lombok.val</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorkerAdvisor</span> <span class="o">{</span>

    <span class="nd">@OnMethodEnter</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">onMethodEnter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span> <span class="c1">// Return current time, entering as parameter in the onMethodExist</span>
    <span class="o">}</span>

    <span class="nd">@OnMethodExit</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onMethodExit</span><span class="o">(</span><span class="nd">@This</span> <span class="n">MonitorAware</span> <span class="n">instance</span><span class="o">,</span> <span class="nd">@Enter</span> <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="nd">@Origin</span> <span class="n">String</span> <span class="n">origin</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">timing</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
        <span class="n">instance</span><span class="o">.</span><span class="na">addExecTimings</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="n">timing</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Method %s was executed in %10.2f ns."</span><span class="o">,</span> <span class="n">origin</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">timing</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>


</code></pre>
</div>

<p>Finally, we need to define a new module in the kamon agent configuration:</p>

<pre><code class="language-hocon">kamon.agent {
  modules {
    example-module {
      name = "Example Module"
      stoppable = false
      instrumentations = ["app.kamon.instrumentation.MonitorInstrumentation"]
      within = [ "app.kamon..*" ] // List of patterns to match the types to instrument.
    }
  }
}
</code></pre>

<p>And you are ready to go!</p>

<p>Next, just run your app with the <code class="highlighter-rouge">kamon-agent</code> as parameter:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>java -javaagent:kamon-agent.jar -jar /path/to/footpath-routing-api.jar
</code></pre>
</div>

<p>There it is! Your app instrumented with kamon-agent ready to introduce kamon under the hook.</p>

<p>Some other configuration that you can define is indicated in the agent <a href="https://github.com/kamon-io/kamon-agent/blob/master/agent/src/main/resources/reference.conf"><code class="highlighter-rouge">reference.conf</code></a></p>

<h2 id="lombok">Lombok</h2>
<p>This project uses <a href="https://projectlombok.org/">Lombok</a> to reduce boilerplate. You can setup
the <a href="https://plugins.jetbrains.com/plugin/6317">IntelliJ plugin</a> to add IDE support.</p>

</div></div></section><section class="technologies"><div class="container"><div class="row"></div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><div class="col-xs-6"><p>kamon-agent is designed and developed by <a href="" target="_blank">kamon-io</a></p></div><div class="col-xs-6"><p class="text-right"><a href="https://github.com/kamon-io/kamon-agent"><span class="fa fa-github"></span>View on GitHub</a></p></div></div><div class="row"><div class="col-xs-6"><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank">Sbt-microsites</a> - © 2016 <a href="https://www.47deg.com/" target="_blank">47 Degrees</a></p></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/kamon-agent/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'kamon-io/kamon-agent'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script></body></html>